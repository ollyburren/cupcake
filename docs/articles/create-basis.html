<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating a basis using cupcake • cupcake</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating a basis using cupcake">
<meta property="og:description" content="cupcake">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cupcake</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/create-basis.html">Creating a basis using cupcake</a>
    </li>
    <li>
      <a href="../articles/project-basis.html">Projecting your data onto an exisiting basis</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="create-basis_files/header-attrs-2.3/header-attrs.js"></script><script src="create-basis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Creating a basis using cupcake</h1>
                        <h4 class="author">Olly Burren</h4>
            
            <h4 class="date">2020-07-28</h4>
      
      
      <div class="hidden name"><code>create-basis.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The function of this package is to facillitate the building of a set of ordered <em>basis</em> vectors from a collection of case/control genome-wide association study summary (GWAS) <span class="math inline">\(\beta\)</span>, or <span class="math inline">\(\log(\text{Odds Ratio})\)</span> statistsics. The building of ordered sets of basis vectors for analysing GWAS genotype data is not new and it’s utility in adjusting for confounding due to population structure is well described. This package seeks to address a different set of questions as to the overall relationship between a set of related (or unrelated) traits for which genotype data may not be available. This follows a logical workflow as follows:-</p>
<ol style="list-style-type: decimal">
<li>Identify a set of traits of interest from which to construct the basis and collect relevant summary statistics.</li>
<li>Idenification of the maximal set of SNPs that are included in all source traits.</li>
<li>Odds ratio (OR) alignment, such that the effect allele for all the traits is standardised.</li>
<li><strong>Basis construction.</strong></li>
<li><strong>Projecting new traits onto the basis.</strong></li>
</ol>
<p>This package is concerned with steps 4 and 5, and whilst the other steps are non-trivial this package assumes access to a set (<span class="math inline">\(n\gt1\)</span>) of OR aligned summary statistics (see section on file formats below as to what is required).</p>
</div>
<div id="installing-cupcake" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-cupcake" class="anchor"></a>Installing cupcake</h2>
<p>You will need to have the <code>devtool</code> R package installed after which the latest version of the package can be installed as follows</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">devtools</span>)
<span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"ollyburren/cupcake"</span>,<span class="kw">build_vignettes</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
</div>
<div id="constructing-a-basis" class="section level1">
<h1 class="hasAnchor">
<a href="#constructing-a-basis" class="anchor"></a>Constructing a basis</h1>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>Here we load cupcake and other useful packages and define the locations of various data files that we will need to construct a basis.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">cupcake</span>)
<span class="co">#&gt; Loading required package: data.table</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">magrittr</span>)
<span class="no">SPARSE_BASIS_EXTDATA</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/find.package.html">path.package</a></span>(<span class="st">"cupcake"</span>),<span class="st">"extdata"</span>,<span class="st">"sparse_imd_basis"</span>)
<span class="no">SNP_MANIFEST_FILE</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'support/sparse_snp_manifest.RDS'</span>)
<span class="no">TRAIT_MANIFEST_FILE</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'support/sparse_trait_manifest.tab'</span>)
<span class="no">SHRINKAGE_FILE</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'support/13_trait_sparse_shrinkage.RDS'</span>)
<span class="no">BASIS_FILE</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'support/13_trait_sparse_basis.RDS'</span>)
<span class="no">GWAS_DATA_DIR</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'/gwas_data/'</span>)
<span class="no">NOSHRINK_BASIS_FILE</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'support/13_trait_sparse_basis_noshrink.RDS'</span>)</pre></body></html></div>
<p>During this vignette we will create a `sparse’ basis relevant to immune mediated diseases (IMD). This sparse basis incorporates data about a small subset of SNPs (<span class="math inline">\(n&lt;500\)</span>) that is sufficient to capture the relationships between the input traits with over 99% accuracy as compared to a full basis where <span class="math inline">\(n \approx 300,000\)</span>. We have found such a sparse basis to be sufficient for most analyses.</p>
<p>If you wish to create your own basis for a set of related traits you should be able to follow this vignette, please note that you will need to define your own set of input files as detailed below.</p>
</div>
<div id="input-files" class="section level2">
<h2 class="hasAnchor">
<a href="#input-files" class="anchor"></a>Input files</h2>
<p>The package expects two manifest files, one describing the SNPs to include in the basis and the other describing the traits . The package makes the choice to define a <code>pid</code> or primary identifier for each SNP, that is a portmanteau of it’s chromomsome and position. For example, given a reference genome assembly of GRCh37, <code>rs2476601</code> which has a position on chromosome 1 of 114,377,568 has a pid of <code>1:114377568</code>. Whilst variants with the same position but differing alleles may exist, the fidelity of any genotyping calls of such a class of variants means that, for practical reasons, they are best removed before basis construction.</p>
<div id="snp-manifest" class="section level3">
<h3 class="hasAnchor">
<a href="#snp-manifest" class="anchor"></a>SNP Manifest</h3>
<p>Each row of this file (see /private/var/folders/zw/s4pwsm154rs7fjpf1v8jcvym0000gp/T/Rtmp3YYB4J/temp_libpath5b8b70f35407/cupcake/extdata/sparse_imd_basis/support/sparse_snp_manifest.RDS) describes a non redundant (see above) set of SNPs to include in the basis. Note that for <em>de novo</em> basis creation this should represent the maximal number of SNPs for which data is available across all basis studies.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">SNP_MANIFEST_FILE</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">.</span>,<span class="kw">n</span><span class="kw">=</span><span class="fl">5</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">pid</th>
<th align="left">ref_a1</th>
<th align="left">ref_a2</th>
<th align="right">ref_a1.af</th>
<th align="right">ld.block</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1:2513216</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="right">0.514546</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">1:2526746</td>
<td align="left">A</td>
<td align="left">G</td>
<td align="right">0.642687</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">1:2709164</td>
<td align="left">C</td>
<td align="left">A</td>
<td align="right">0.666887</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">1:4698559</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="right">0.839196</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="left">1:8180210</td>
<td align="left">G</td>
<td align="left">A</td>
<td align="right">0.808120</td>
<td align="right">17</td>
</tr>
</tbody>
</table>
<ol style="list-style-type: decimal">
<li>pid - See above.</li>
<li>ref_a1 - Allele 1 (A/G/C/T/I/D).</li>
<li>ref_a2 - Allele 2 (A/G/C/T/I/D) - the effect allele.</li>
<li>ref_a1.af - The allele frequency of ref_a1 (estimated from a suitable reference population).</li>
<li>ld.block - A number grouping a block of SNPs in high LD (see note).</li>
</ol>
<p>The ld.block column assigns each SNP to an approximately LD independent block. We have derived ours from HapMap recombination data and these are available in /private/var/folders/zw/s4pwsm154rs7fjpf1v8jcvym0000gp/T/Rtmp3YYB4J/temp_libpath5b8b70f35407/cupcake/extdata/sparse_imd_basis/hapmap.ld.tab.</p>
</div>
<div id="trait-manifest" class="section level3">
<h3 class="hasAnchor">
<a href="#trait-manifest" class="anchor"></a>Trait Manifest</h3>
<p>Each row of this file describes a trait (see /private/var/folders/zw/s4pwsm154rs7fjpf1v8jcvym0000gp/T/Rtmp3YYB4J/temp_libpath5b8b70f35407/cupcake/extdata/sparse_imd_basis/support/sparse_trait_manifest.tab) toinclude in basis creation.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu">fread</span>(<span class="no">TRAIT_MANIFEST_FILE</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">.</span>,<span class="kw">n</span><span class="kw">=</span><span class="fl">5</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">trait</th>
<th align="left">disease</th>
<th align="right">cases</th>
<th align="right">controls</th>
<th align="left">pmid</th>
<th align="left">file</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">VIT</td>
<td align="left">vitiligo_jin</td>
<td align="right">4680</td>
<td align="right">39586</td>
<td align="left">27723757</td>
<td align="left">vitiligo_jin.tab</td>
</tr>
<tr class="even">
<td align="left">UC</td>
<td align="left">uc_delaange</td>
<td align="right">12366</td>
<td align="right">33609</td>
<td align="left">28067908</td>
<td align="left">uc_delaange.tab</td>
</tr>
<tr class="odd">
<td align="left">CD</td>
<td align="left">cd_delaange</td>
<td align="right">12194</td>
<td align="right">28072</td>
<td align="left">28067908</td>
<td align="left">cd_delaange.tab</td>
</tr>
<tr class="even">
<td align="left">RA</td>
<td align="left">ra_okada</td>
<td align="right">14361</td>
<td align="right">43923</td>
<td align="left">24390342</td>
<td align="left">ra_okada.tab</td>
</tr>
<tr class="odd">
<td align="left">SLE</td>
<td align="left">sle_bentham</td>
<td align="right">4036</td>
<td align="right">6959</td>
<td align="left">26502338</td>
<td align="left">sle_bentham.tab</td>
</tr>
</tbody>
</table>
<ol style="list-style-type: decimal">
<li>trait - Short label for a trait</li>
<li>disease - Human readable name for the trait e.g. Juvenile Idiopathic Arthritis.</li>
<li>cases - Number of cases in the study.</li>
<li>controls - Number of controls in the study.</li>
<li>file - Name of the summary statistic source file (see below) to use e.g. JIA.tab. These are all expected to be in the same directory (see <code>GWAS_DATA_DIR</code>)</li>
</ol>
</div>
</div>
<div id="gwas-source-file" class="section level2">
<h2 class="hasAnchor">
<a href="#gwas-source-file" class="anchor"></a>GWAS source file</h2>
<p>Each row of this file describes the effect and signficance for a set of alleles for a trait which can be derived from the set of GWAS summary statistics for a trait. Effect alleles are expected to match the snp manifest and are duplicated to allow checking. The file should contain either a matching or superset of SNPs described in <code>SNP_MANIFEST_FILE</code>. SNPs that are not found in the <code>SNP_MANIFEST_FILE</code> are excluded, SNPs missing in the input file or for which odds ratio estimates <span class="math inline">\(\in \{0,1\}\)</span> are set to zero.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">GWAS_DATA_DIR</span>,<span class="fu">fread</span>(<span class="no">TRAIT_MANIFEST_FILE</span>)[<span class="fl">1</span>,]$<span class="no">file</span>) <span class="kw">%&gt;%</span> <span class="no">fread</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">.</span>,<span class="kw">n</span><span class="kw">=</span><span class="fl">5</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">pid</th>
<th align="left">a1</th>
<th align="left">a2</th>
<th align="right">or</th>
<th align="right">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.99</td>
<td align="right">6.52e-01</td>
</tr>
<tr class="even">
<td align="left">10:112186148</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="right">0.98</td>
<td align="right">4.28e-01</td>
</tr>
<tr class="odd">
<td align="left">10:115481018</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="right">0.83</td>
<td align="right">0.00e+00</td>
</tr>
<tr class="even">
<td align="left">10:131562993</td>
<td align="left">G</td>
<td align="left">T</td>
<td align="right">1.21</td>
<td align="right">1.30e-06</td>
</tr>
<tr class="odd">
<td align="left">10:27177245</td>
<td align="left">A</td>
<td align="left">G</td>
<td align="right">1.04</td>
<td align="right">3.69e-01</td>
</tr>
</tbody>
</table>
<ol style="list-style-type: decimal">
<li>pid - as for the SNP manifest.</li>
<li>a1 - Allele 1 - should match SNP manifest.</li>
<li>a2 - Allele 2 (effect allele)</li>
<li>or - Odds ration with respect to a2.</li>
<li>p.value</li>
</ol>
<p><strong>N.B If creating your own basis it is critical that odds ratios are aligned, failure to do so will result in a junk basis.</strong></p>
</div>
<div id="loading-in-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-in-data" class="anchor"></a>Loading in data</h2>
<p>The loading of data is handled through <code>get_gwas_data</code> routine like so</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">gwas.DT</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/get_gwas_data.html">get_gwas_data</a></span>(<span class="no">TRAIT_MANIFEST_FILE</span>,<span class="no">SNP_MANIFEST_FILE</span>,<span class="no">GWAS_DATA_DIR</span>)
<span class="co">#&gt; Processing VIT</span>
<span class="co">#&gt; Processing UC</span>
<span class="co">#&gt; Processing CD</span>
<span class="co">#&gt; Processing RA</span>
<span class="co">#&gt; Processing SLE</span>
<span class="co">#&gt; Processing T1D</span>
<span class="co">#&gt; Processing PSC</span>
<span class="co">#&gt; Processing asthma</span>
<span class="co">#&gt; Processing PBC</span>
<span class="co">#&gt; Processing CEL</span>
<span class="co">#&gt; Processing MS</span>
<span class="co">#&gt; Adding reference snp manifest annotations</span></pre></body></html></div>
<p>The <code>data.table</code> object <code>gwas.DT</code> contains all the data required for the next step of calculating the shrinkage values to appy to the <span class="math inline">\(\beta\)</span> of all traits.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">gwas.DT</span>,<span class="kw">n</span><span class="kw">=</span><span class="fl">10</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">pid</th>
<th align="left">a1</th>
<th align="left">a2</th>
<th align="right">or</th>
<th align="right">p.value</th>
<th align="left">trait</th>
<th align="right">n</th>
<th align="right">n1</th>
<th align="right">maf</th>
<th align="right">ld.block</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.990</td>
<td align="right">6.52e-01</td>
<td align="left">VIT</td>
<td align="right">44266</td>
<td align="right">4680</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="even">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.862</td>
<td align="right">0.00e+00</td>
<td align="left">UC</td>
<td align="right">45975</td>
<td align="right">12366</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.850</td>
<td align="right">0.00e+00</td>
<td align="left">CD</td>
<td align="right">40266</td>
<td align="right">12194</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="even">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">1.000</td>
<td align="right">8.30e-01</td>
<td align="left">RA</td>
<td align="right">58284</td>
<td align="right">14361</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">1.000</td>
<td align="right">8.79e-01</td>
<td align="left">SLE</td>
<td align="right">10995</td>
<td align="right">4036</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="even">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.966</td>
<td align="right">1.62e-01</td>
<td align="left">T1D</td>
<td align="right">14742</td>
<td align="right">5913</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.876</td>
<td align="right">1.52e-05</td>
<td align="left">PSC</td>
<td align="right">24751</td>
<td align="right">4796</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="even">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.987</td>
<td align="right">3.25e-01</td>
<td align="left">asthma</td>
<td align="right">127669</td>
<td align="right">19954</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">1.010</td>
<td align="right">8.61e-01</td>
<td align="left">PBC</td>
<td align="right">13239</td>
<td align="right">2764</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
<tr class="even">
<td align="left">10:101291593</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="right">0.981</td>
<td align="right">4.57e-01</td>
<td align="left">CEL</td>
<td align="right">15283</td>
<td align="right">4533</td>
<td align="right">0.480825</td>
<td align="right">1984</td>
</tr>
</tbody>
</table>
</div>
<div id="computing-shrinkage-for-illustrative-purposes-only" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-shrinkage-for-illustrative-purposes-only" class="anchor"></a>computing shrinkage (for illustrative purposes only)</h2>
<p>Next we use the <code>data.table</code> created to compute shrinkages like so</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">shrink.DT</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/compute_shrinkage_metrics.html">compute_shrinkage_metrics</a></span>(<span class="no">gwas.DT</span>)
<span class="co">#&gt; Computing maf_se_estimated using or, sample size and p.value</span>
<span class="co">#&gt; Computing weighted pp shrinkage</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">shrink.DT</span>,<span class="kw">n</span><span class="kw">=</span><span class="fl">10</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">pid</th>
<th align="right">shrinkage</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">10:101291593</td>
<td align="right">0.2214884</td>
</tr>
<tr class="even">
<td align="left">10:112186148</td>
<td align="right">0.1688061</td>
</tr>
<tr class="odd">
<td align="left">10:115481018</td>
<td align="right">0.1443190</td>
</tr>
<tr class="even">
<td align="left">10:131562993</td>
<td align="right">0.0925682</td>
</tr>
<tr class="odd">
<td align="left">10:27177245</td>
<td align="right">0.1409768</td>
</tr>
<tr class="even">
<td align="left">10:30802799</td>
<td align="right">0.1630738</td>
</tr>
<tr class="odd">
<td align="left">10:33426147</td>
<td align="right">0.1701374</td>
</tr>
<tr class="even">
<td align="left">10:35359619</td>
<td align="right">0.1798183</td>
</tr>
<tr class="odd">
<td align="left">10:59893930</td>
<td align="right">0.0841185</td>
</tr>
<tr class="even">
<td align="left">10:6106266</td>
<td align="right">0.0358252</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong> that this shrinkage object is for illustrative purposes only and it should <strong>not</strong> be generated from a sparse map of SNPs such as the one included in this package.</p>
</div>
<div id="creating-the-basis" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-the-basis" class="anchor"></a>Creating the basis</h2>
<p>The final step is to create a basis. This can be done using the <code>create_basis</code> command. Note there is an <code>apply.shrinkage</code> option that allows the creation of a basis without the application of any shrinkage.</p>
<p>The final step is to create a basis from the two input traits, firstly we apply shrinkages and line up variants across studies using <code>create_ds_matrix</code>. Next we add a null or <code>control</code> study in order to anchor the basis. In practice this means adding a row of zeroes to</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co">## create a basis without using the shrinkages</span>
<span class="no">basis.noshrink</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/create_basis.html">create_basis</a></span>(<span class="no">gwas.DT</span>,<span class="no">shrink.DT</span>,<span class="kw">apply.shrinkage</span><span class="kw">=</span><span class="fl">FALSE</span>)
<span class="co">#&gt; Warning: No shrinkage will be applied!</span>
<span class="co">#&gt; Using none</span>
<span class="no">basis</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/create_basis.html">create_basis</a></span>(<span class="no">gwas.DT</span>,<span class="no">shrink.DT</span>)
<span class="co">#&gt; Using shrinkage</span></pre></body></html></div>
</div>
<div id="visualising-basis" class="section level2">
<h2 class="hasAnchor">
<a href="#visualising-basis" class="anchor"></a>Visualising basis</h2>
<p>We can look at a simple biplot of the first two principal components (PCs) of both bases to look at broad differences between them.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))

<span class="co">#plot no shrinkage</span>
<span class="no">plot.no.DT</span> <span class="kw">&lt;-</span> <span class="fu">data.table</span>(<span class="kw">trait</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">basis.noshrink</span>$<span class="no">x</span>),<span class="no">basis.noshrink</span>$<span class="no">x</span>)
<span class="no">xlim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.no.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">PC1</span>),<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">PC1</span>)) * <span class="fl">1.2</span>)
<span class="no">ylim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.no.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">PC2</span>),<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">PC2</span>)) * <span class="fl">1.2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.no.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">PC1</span>,<span class="no">PC2</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">'n'</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="no">xlim</span>,<span class="kw">ylim</span><span class="kw">=</span><span class="no">ylim</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"No shrinkage"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.no.DT</span>,<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="no">PC1</span>,<span class="no">PC2</span>,<span class="kw">labels</span><span class="kw">=</span><span class="no">trait</span>, <span class="kw">cex</span><span class="kw">=</span> <span class="fl">0.8</span>,<span class="kw">adj</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">0</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.no.DT</span>,<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="no">PC1</span>,<span class="no">PC2</span>,<span class="kw">cex</span><span class="kw">=</span><span class="fl">0.5</span>,<span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>))

<span class="co">#plot shrinkage</span>
<span class="no">plot.DT</span> <span class="kw">&lt;-</span> <span class="fu">data.table</span>(<span class="kw">trait</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">basis</span>$<span class="no">x</span>),<span class="no">basis</span>$<span class="no">x</span>)
<span class="no">xlim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">PC1</span>),<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">PC1</span>)) * <span class="fl">1.2</span>)
<span class="no">ylim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">PC2</span>),<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">PC2</span>)) * <span class="fl">1.2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">PC1</span>,<span class="no">PC2</span>,<span class="kw">type</span><span class="kw">=</span><span class="st">'n'</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="no">xlim</span>,<span class="kw">ylim</span><span class="kw">=</span><span class="no">ylim</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"With shrinkage"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>,<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="no">PC1</span>,<span class="no">PC2</span>,<span class="kw">labels</span><span class="kw">=</span><span class="no">trait</span>, <span class="kw">cex</span><span class="kw">=</span> <span class="fl">0.8</span>, <span class="kw">adj</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">0</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>,<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="no">PC1</span>,<span class="no">PC2</span>,<span class="kw">cex</span><span class="kw">=</span><span class="fl">0.5</span>,<span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>))</pre></body></html></div>
<p><img src="create-basis_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>In this case they are broadly similar which we might expect given that the SNPs used in the sparse basis have been preselected based on their shrinkages. There are more subtle differences, for example PC2 scores across most traits are attenuated (relatively) for the shrunk basis compared to the unshrunk basis.</p>
</div>
</div>
<div id="projecting-data-onto-the-basis" class="section level1">
<h1 class="hasAnchor">
<a href="#projecting-data-onto-the-basis" class="anchor"></a>Projecting data onto the basis</h1>
<p>Whilst the basis created has some interest its primary purpose is to project on an external dataset. Here we project on summary statistics from UK Biobank for self-reported SLE status (obtained from <a href="http://www.nealelab.is/uk-biobank">Neale Laboratory UKBB round 2</a> using the <code>project_basis</code> command. To do this we use a pregenerated sparse basis based on 13 IMD diseases. One hypothesis might be that we expect this projected SLE dataset to sit closer to the basis SLE projection than other traits. Here we perform this analysis using bases with both with and without shrinkage using standard aglommerative hierarchical clustering in order to compare PC scores across traits.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">basis</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">BASIS_FILE</span>)
<span class="no">basis.noshrink</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">NOSHRINK_BASIS_FILE</span>)
<span class="no">shrink.DT</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">SHRINKAGE_FILE</span>)
<span class="no">sle.DT</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">GWAS_DATA_DIR</span>,<span class="st">'ukbb_neale_srd_sle.tab'</span>) <span class="kw">%&gt;%</span> <span class="no">fread</span>
<span class="no">sle.proj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/project_basis.html">project_basis</a></span>(<span class="no">sle.DT</span>,<span class="no">shrink.DT</span>,<span class="no">basis</span>,<span class="kw">traitname</span><span class="kw">=</span><span class="st">'UKBB:SLE'</span>)
<span class="no">sle.noshrink.proj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/project_basis.html">project_basis</a></span>(<span class="no">sle.DT</span>,<span class="no">shrink.DT</span>,<span class="no">basis.noshrink</span>,<span class="kw">traitname</span><span class="kw">=</span><span class="st">'UKBB:SLE'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">sle.proj</span>$<span class="no">proj</span>,<span class="no">basis.noshrink</span>$<span class="no">x</span>) <span class="kw">%&gt;%</span> <span class="no">dist</span> <span class="kw">%&gt;%</span> <span class="no">hclust</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">.</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"No shrinkage"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">sle.proj</span>$<span class="no">proj</span>,<span class="no">basis</span>$<span class="no">x</span>) <span class="kw">%&gt;%</span> <span class="no">dist</span> <span class="kw">%&gt;%</span> <span class="no">hclust</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">.</span>,<span class="kw">main</span><span class="kw">=</span><span class="st">"With shrinkage"</span>)</pre></body></html></div>
<p><img src="create-basis_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>Here we can see that with ‘No shrinkage’, relationships between basis traits seem less clear and UKBB:SLE cluster with ‘control’. ‘With shrinkage’ our hypothesis is borne out such that UKBB:SLE projection clusters with the basis SLE.</p>
</div>
<div id="testing-projection-for-significant-deviation-from-pseudo-control" class="section level1">
<h1 class="hasAnchor">
<a href="#testing-projection-for-significant-deviation-from-pseudo-control" class="anchor"></a>Testing projection for significant deviation from pseudo-control</h1>
<p>In order to prioritise individual components we might wish to assess the significance for a projected trait. One approach is to assess, for a given component, whether the projected score under consideration differs significantly from the pseudo-control. This requires an estimation of the standard error of the projected trait score <span class="math inline">\(\sigma_{\text{proj}}\)</span>, which in turn depends on the variance of the traits estimated effect sizes (<span class="math inline">\(\sigma_{\hat{\beta}}\)</span>) for each basis SNP as well as their covariance.</p>
<p>In the absence of reported <span class="math inline">\(\sigma_{\hat{\beta}}\)</span> this can be back calculated (albeit with a loss of precision) by <span class="math inline">\(\sigma_{\hat{\beta}} = \frac{\hat{\beta}}{\Phi^{-1}(p/2)}\)</span>, where <span class="math inline">\(p\)</span> is the <span class="math inline">\(p\)</span>-value reported and <span class="math inline">\(\Phi^{-1}(p/2)\)</span> is the inverse cumulative normal distribution. The covariance of these can be computed by using a set of reference genotypes to estimate genotypic correlation, here we use individuals of European ancestry from 1000 genomes reference genotypes in snpMatrix format.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="co">## load in reference genotypes - note these are</span>
<span class="no">REF_GT</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">SPARSE_BASIS_EXTDATA</span>,<span class="st">'support/1KG_reference_genotypes.RDS'</span>)
<span class="no">sm.1kg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">REF_GT</span>)
<span class="co">## convert basis rotation matrix to data.table</span>
<span class="no">w.DT</span> <span class="kw">&lt;-</span> <span class="fu">data.table</span>(<span class="kw">pid</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">basis</span>$<span class="no">rotation</span>),<span class="no">basis</span>$<span class="no">rotation</span>)
<span class="co">## compute variance associated with projecting sle.DT dataset</span>
<span class="no">var.seb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cupcake/man/compute_seb_proj_var_sparse.html">compute_seb_proj_var_sparse</a></span>(<span class="no">sle.DT</span>,<span class="no">shrink.DT</span>,<span class="no">w.DT</span>,<span class="no">sm.1kg</span>,<span class="kw">method</span><span class="kw">=</span><span class="st">'shrinkage'</span>,<span class="kw">quiet</span><span class="kw">=</span><span class="fl">TRUE</span>)</pre></body></html></div>
<p>We can use this variance estimation to assess significance such that <span class="math inline">\(Z = \frac{\text{PC}_{\text{proj}} - \text{PC}_{\text{control}}}{\sigma_{\text{proj}}}\)</span>, which can be used to compute a <span class="math inline">\(p\)</span>-value.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">Z.pcs</span> <span class="kw">&lt;-</span> (<span class="no">sle.proj</span>$<span class="no">proj</span> - <span class="no">basis</span>$<span class="no">x</span>[<span class="st">'control'</span>,])/<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">var.seb</span>)
<span class="no">p.pcs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">Z.pcs</span>),<span class="kw">lower.tail</span><span class="kw">=</span><span class="fl">FALSE</span>) * <span class="fl">2</span>
<span class="co">## note pcs which are significant taking into account multiple testing</span>
<span class="no">keep.pcs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">p.pcs</span>)[<span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span>(<span class="no">p.pcs</span>,<span class="kw">method</span><span class="kw">=</span><span class="st">'bonferroni'</span>) <span class="kw">&lt;</span> <span class="fl">0.05</span>]</pre></body></html></div>
<p>From this we can see that our projected dataset has two significant components PC1and PC2. We can summarise graphically out findings in the context of basis traits as follows. <strong>N.B</strong> note that as basis traits are used to create the basis they have no associated confidence intervals.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co">## combine projected with basis traits and centre to control disease</span>
<span class="no">dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">basis</span>$<span class="no">x</span>,<span class="fl">1</span>,<span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>-<span class="no">basis</span>$<span class="no">x</span>[<span class="st">'control'</span>,]) <span class="kw">%&gt;%</span> <span class="no">t</span>,<span class="no">sle.proj</span>$<span class="no">proj</span> - <span class="no">basis</span>$<span class="no">x</span>[<span class="st">'control'</span>,])
<span class="co">## convert to data.table and remove control</span>
<span class="no">dat.DT</span> <span class="kw">&lt;-</span> <span class="fu">data.table</span>(<span class="kw">trait</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">dat</span>),<span class="no">dat</span>)[<span class="no">trait</span><span class="kw">!=</span><span class="st">'control'</span>,]
<span class="co">## short fat table to long thin keeping only significant pcs</span>
<span class="no">dat.DT</span> <span class="kw">&lt;-</span> <span class="fu">melt</span>(<span class="no">dat.DT</span>,<span class="kw">id.vars</span><span class="kw">=</span><span class="st">'trait'</span>)[<span class="no">variable</span> <span class="kw">%in%</span> <span class="no">keep.pcs</span>,]
<span class="fu">setnames</span>(<span class="no">dat.DT</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'variable'</span>,<span class="st">'value'</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'pc'</span>,<span class="st">'delta'</span>))
<span class="co">## compute confidence intervals for projected dataset.</span>
<span class="no">ci</span> <span class="kw">&lt;-</span> (<span class="no">var.seb</span>[<span class="no">keep.pcs</span>] <span class="kw">%&gt;%</span> <span class="no">sqrt</span>) * <span class="fl">1.96</span>
<span class="no">dat.DT</span>[<span class="no">trait</span><span class="kw">==</span><span class="st">'UKBB:SLE'</span>,<span class="no">ci</span><span class="kw">:=</span><span class="no">ci</span>]
<span class="co">## plotting code</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))
<span class="kw">for</span>(<span class="no">p</span> <span class="kw">in</span> <span class="no">keep.pcs</span>){
  <span class="no">plot.DT</span> <span class="kw">&lt;-</span> <span class="no">dat.DT</span>[<span class="no">pc</span><span class="kw">==</span><span class="no">p</span>,][<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">delta</span>,<span class="kw">decreasing</span> <span class="kw">=</span> <span class="fl">TRUE</span>),]
  <span class="no">xl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">plot.DT</span>$<span class="no">delta</span>-<span class="no">ci</span>,<span class="no">plot.DT</span>$<span class="no">delta</span>+<span class="no">ci</span>)
  <span class="no">idx</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">plot.DT</span>$<span class="no">ci</span>))
  <span class="no">cols</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">'black'</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">plot.DT</span>))
  <span class="no">cols</span>[<span class="no">idx</span>] <span class="kw">&lt;-</span> <span class="st">'red'</span>
  {
    <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>,<span class="fu"><a href="https://rdrr.io/r/graphics/dotchart.html">dotchart</a></span>(<span class="no">delta</span>,<span class="kw">labels</span><span class="kw">=</span><span class="no">trait</span>,<span class="kw">xlim</span><span class="kw">=</span><span class="no">xl</span>,<span class="kw">pch</span><span class="kw">=</span><span class="fl">19</span>,
                          <span class="kw">main</span><span class="kw">=</span><span class="no">p</span>,<span class="kw">xlab</span><span class="kw">=</span><span class="st">"Delta PC score"</span>,
                          <span class="kw">col</span><span class="kw">=</span><span class="no">cols</span>))
    <span class="co">## add 95% confidence intervals</span>
    <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">plot.DT</span>[<span class="no">idx</span>,],<span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span>(<span class="no">delta</span>-<span class="no">ci</span>, <span class="no">idx</span>, <span class="no">delta</span>+<span class="no">ci</span>, <span class="no">idx</span>, <span class="kw">length</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">angle</span><span class="kw">=</span><span class="fl">90</span>, <span class="kw">code</span><span class="kw">=</span><span class="fl">3</span>,<span class="kw">col</span><span class="kw">=</span><span class="st">'red'</span>))
    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">col</span><span class="kw">=</span><span class="st">'red'</span>,<span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)
  }
}</pre></body></html></div>
<p><img src="create-basis_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Olly Burren, Chris Wallace.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
